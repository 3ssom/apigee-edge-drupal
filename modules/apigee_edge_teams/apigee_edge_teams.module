<?php

/**
 * @file
 * Copyright 2018 Google Inc.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 * MA 02110-1301, USA.
 */

use Drupal\Core\Breadcrumb\Breadcrumb;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Link;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\StringTranslation\TranslatableMarkup;

/**
 * Implements hook_module_implements_alter().
 */
function apigee_edge_teams_module_implements_alter(&$implementations, $hook) {
  if (\Drupal::moduleHandler()->moduleExists('devel') && $hook === 'entity_type_alter') {
    // Move apigee_edge_teams_entity_type_alter() to the end of the list if
    // Devel module is enabled.
    // @see devel_entity_type_alter()
    $group = $implementations['apigee_edge_teams'];
    unset($implementations['apigee_edge_teams']);
    $implementations['apigee_edge_teams'] = $group;
  }
}

/**
 * Implements hook_entity_type_alter().
 */
function apigee_edge_teams_entity_type_alter(array &$entity_types) {
  // Fixes Team App entity routes generated by the Devel module.
  // @see devel_entity_type_alter()
  // @see \Drupal\apigee_edge_teams\Routing\TeamAppDevelRouteFixerSubscriber
  if (\Drupal::moduleHandler()->moduleExists('devel')) {
    /** @var \Drupal\Core\Entity\EntityTypeInterface $entity_type */
    $entity_type = &$entity_types['team_app'];
    if ($entity_type->hasLinkTemplate('canonical')) {
      $canonical_link = $entity_type->getLinkTemplate('canonical');
      $entity_type->setLinkTemplate('devel-render', "{$canonical_link}/devel-render");
      $entity_type->setLinkTemplate('devel-definition', "{$canonical_link}/devel-definition");
      if ($entity_type->hasLinkTemplate('edit-form')) {
        $entity_type->setLinkTemplate('devel-load', "{$canonical_link}/devel-load");
      }
    }
  }
}

/**
 * Gets the title of team listing page.
 *
 * @return \Drupal\Core\StringTranslation\TranslatableMarkup
 *   The title of the page.
 */
function apigee_edge_teams_team_listing_page_title(): TranslatableMarkup {
  $args['@teams'] = \Drupal::entityTypeManager()->getDefinition('team')->getPluralLabel();
  $title = t('@teams', $args);
  // Modules and themes can alter the title.
  \Drupal::moduleHandler()->alter('apigee_edge_teams_team_listing_page_title', $title);

  return $title;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function apigee_edge_teams_form_entity_form_display_edit_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form['#entity_type'] === 'team_app') {
    $form['#validate'][] = '_apigee_edge_teams_team_app_entity_form_display_edit_form_validate';
  }
}

/**
 * Extra validation for the entity_form_display.edit form of team apps.
 *
 * This makes sure that fields marked as 'required' can't be disabled.
 *
 * @param array $form
 *   Form array.
 * @param Drupal\Core\Form\FormStateInterface $form_state
 *   Form state.
 */
function _apigee_edge_teams_team_app_entity_form_display_edit_form_validate(array &$form, FormStateInterface $form_state) {
  $required = \Drupal::config('apigee_edge_teams.team_app_settings')->get('required_base_fields');

  foreach ($form_state->getValue('fields') as $field_name => $data) {
    if (in_array($field_name, $required) && $data['region'] === 'hidden') {
      $form_state->setError($form['fields'][$field_name], t('%field-name is required.', [
        '%field-name' => $form['fields'][$field_name]['human_name']['#plain_text'],
      ]));
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function apigee_edge_teams_developer_delete(EntityInterface $entity) {
  /** @var \Drupal\apigee_edge\Entity\DeveloperInterface $entity */
  /** @var \Drupal\apigee_edge_teams\CompanyMembershipObjectCacheInterface $cache */
  $cache = \Drupal::service('apigee_edge_teams.cache.company_membership_object');
  // Remove all company membership object cache entries that contained the
  // removed developer.
  $cache->invalidateMemberships(["developer:{$entity->getEmail()}"]);
}

/**
 * Implements hook_system_breadcrumb_alter().
 */
function apigee_edge_teams_system_breadcrumb_alter(Breadcrumb &$breadcrumb, RouteMatchInterface $route_match, array $context) {
  if ($route_match->getRouteName() === 'entity.team.add_form') {
    $team_entity_def = \Drupal::entityTypeManager()->getDefinition('team');
    $breadcrumb->addLink(Link::createFromRoute($team_entity_def->getPluralLabel(), 'entity.team.collection'));
  }
  elseif ($route_match->getRouteName() === 'entity.team.members.add') {
    /** @var \Drupal\apigee_edge_teams\Entity\TeamInterface $team */
    $team = $route_match->getParameter('team');
    $breadcrumb->addLink($team->toLink(t('Members'), 'members'));
  }
  elseif ($route_match->getRouteName() === 'entity.team_app.add_form_for_team') {
    $team_app_entity_def = \Drupal::entityTypeManager()->getDefinition('team_app');
    /** @var \Drupal\apigee_edge_teams\Entity\TeamInterface $team */
    $team = $route_match->getParameter('team');
    $breadcrumb->addLink(Link::createFromRoute($team_app_entity_def->getPluralLabel(), 'entity.team_app.collection_by_team', ['team' => $team->id()]));
  }
}
